---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.19.1
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
import inspect
import itertools

import numpy as np

import skimage as ski
import skimage.segmentation as ss
```

```{python}
cell_4d = ski.data.cells3d()
imgs = (cell_4d[:, 0],  # Membranes
        cell_4d[:, 1],  # Nuclei
        ski.data.brain())
img = imgs[0]
```

```{python}
img.shape
```

```{python}
ws_orig = ss.watershed(img)
```

```{python}
def rolled_ws(img, axes):
    r_img = np.transpose(img, axes)
    f_r_img = ss.watershed(r_img)
    return np.transpose(f_r_img, np.argsort(axes))
```

```{python}
def assert_labels_equivalent(label_1, label_2):
    uq_labels_1 = np.unique(label_1)
    uq_labels_2 = np.unique(label_2)
    assert np.all(uq_labels_1 == uq_labels_2)
    unclaimed = list(uq_labels_2)
    for label in uq_labels_1:
        mask = label_1 == label
        in_mask = label_2[mask]
        label_other = in_mask[0]
        assert np.all(in_mask == label_other)
        unclaimed.remove(label_other)
    assert len(unclaimed) == 0
```

```{python}
ws_rolled = rolled_ws(img, (2, 1, 0))
assert assert_labels_equivalent(ws_rolled, ws_orig)
```

```{python}
orderings = set(itertools.permutations(range(3), 3))
orderings.remove((0, 1, 2))
```

```{python}
for i, img in enumerate(imgs):
    ws_start = ss.watershed(img)
    print(f'Image {i}')
    for order in orderings:
        print(f'Ordering {order}')
        ws_s_r = rolled_ws(img, order)
        assert assert_labels_equavalent(ws_s_r, ws_start)
```
